<!-- index.html --> 
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>CoAP Web GUI</title>
  <style>
    body { font-family: 'Times New Roman', Times, serif; max-width: 800px; margin: 20px auto; }
    button { margin: 5px; padding: 6px 12px; }
    textarea { width: 100%; height: 150px; margin-top: 10px; }
    .node { border: 1px solid #ccc; padding: 10px; margin-bottom: 15px; }
    .node h3 { margin: 0 0 10px 0; }
    .alarm { border-color: red; background-color: #fee; }
    ul { list-style-type: none; padding-left: 0; }
    li { margin-bottom: 4px; }
  </style>
</head>
<body>
  <h1>CoAP Web GUI</h1>
  <button onclick="getSensors()">Get Sensor Data</button>

  <div id="nodes-container">
    <!-- Node data will be dynamically inserted here -->
  </div>

  <h3>Raw JSON:</h3>
  <textarea id="output"></textarea>

<script>
  async function getSensors() {
    const r = await fetch('/sensors');

    if (!r.ok) {
      document.getElementById('output').value = 'No data yet';
      document.getElementById('nodes-container').innerHTML = '';
      return;
    }

    const data = await r.json();
    updateNodes(data);
    document.getElementById('output').value = JSON.stringify(data, null, 2);
  }

  function updateNodes(data) {
    const container = document.getElementById('nodes-container');
    container.innerHTML = ''; // clear previous

    for (const nodeId in data) {
      const nodeData = data[nodeId];
      const div = document.createElement('div');
      div.className = 'node';


      // Determine if any alarm condition is met for this node
      const isAlarm = 
        (nodeData.temperature > 30) ||
        (nodeData.humidity > 80) ||
        (nodeData.pressure < 950 || nodeData.pressure > 1050) ||
        (nodeData.gas > 400) ||
        nodeData.vibration ||
        (nodeData.sound > 50);

      if (isAlarm) {
        div.classList.add('alarm');
      }

      div.innerHTML = `
        <h3>${nodeId}</h3>
        <ul>
          <li>Temperature: ${nodeData.temperature ?? '-'} Â°C</li>
          <li>Humidity: ${nodeData.humidity ?? '-'} %</li>
          <li>Pressure: ${nodeData.pressure ?? '-'} hPa</li>
          <li>Gas (CO): ${nodeData.gas ?? '-'}</li>
          <li>Sound: ${nodeData.sound ? 'YES' : 'NO'}</li>
          <li>Vibration: ${nodeData.vibration ? 'YES' : 'NO'}</li>
        </ul>
      `;
      container.appendChild(div);
    }
  }

  // Auto-refresh every 5s
  setInterval(getSensors, 5000);

  // Initial fetch
  getSensors();
</script>


<button onclick="triggerTestAlarm()">Test Alarm</button>

<script>
  async function triggerTestAlarm() {
    try {
      const r = await fetch('/test-alarm', { method: 'POST' });
      if (r.ok) {
        alert('Test alarm triggered!');
      } else {
        alert('Failed to trigger test alarm');
      }
    } catch (err) {
      console.error(err);
      alert('Error triggering test alarm');
    }
  }
</script>

</body>
</html>
